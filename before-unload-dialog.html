<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <div id="text">
    </div>
    <div id="views"></div>
    <div>
        <button onclick="goAheadWithClose()">OK</button>
        <button onclick="cancel()">Cancel</button>
    </div>

    <script>
        const params = new URLSearchParams(window.location.search);

        async function cancel() {
            try {
                await fin.InterApplicationBus.publish('user-decision', false);
                window.close();
            } catch (error) {
                console.log(error);
            }
        }

        function populatePreventedViews() {
            const viewsObj = params.get('views');
            const viewsArr = JSON.parse(viewsObj).views;

            viewsArr.forEach(view => {
                const viewP = document.createElement('p');
                viewP.innerHTML = view.name;
                document.querySelector('#views').appendChild(viewP);
            });
        }

        function populate() {
            const closeType = params.get('closeType');

            if (closeType === 'view') {
                const p = document.createElement('p');
                p.innerHTML = 'Are you sure you want to close this view? It may have unsaved changes.';
                document.querySelector('#text').appendChild(p);
            }

            if (closeType === 'window') {
                const p1 = document.createElement('p');
                p1.innerHTML = 'Are you sure you want to close this window?';
                document.querySelector('#text').appendChild(p1);

                const p2 = document.createElement('p');
                p2.innerHTML = 'The following views may have unsaved changes:';
                document.querySelector('#text').appendChild(p2);

                populatePreventedViews();
            }
        }

        async function goAheadWithClose() { 
            try {
                await fin.InterApplicationBus.publish('user-decision', true);
                window.close();
            } catch (error) {
                console.log(error);
            }  
        }

        document.addEventListener('DOMContentLoaded', () => {
            populate();
        });
    </script>
</body>

</html>